import os
import re
import time
import requests
import pandas as pd
from tqdm import tqdm

# í…ìŠ¤íŠ¸ í† í¬ë‚˜ì´ì € ë° ì‹œí€€ìŠ¤ íŒ¨ë”©
from tensorflow.keras.preprocessing.text     import Tokenizer
from tensorflow.keras.preprocessing.sequence import pad_sequences

# ëª¨ë¸ ë° í•™ìŠµ ë„êµ¬
from sklearn.model_selection import train_test_split
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Embedding, Bidirectional, LSTM, Dropout, Dense
from tensorflow.keras.callbacks import ModelCheckpoint, EarlyStopping

# ì‹œê°í™”
import matplotlib.pyplot as plt
from wordcloud import WordCloud

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) LM Studio ì„¤ì •
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
API_URL    = "http://127.0.0.1:1234/v1/completions"
MODEL_NAME = "google/gemma-3-12b"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2) í”„ë¡¬í”„íŠ¸ êµ¬ì„±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def make_batch_prompt(reviews):
    prompt = (
        "ì•„ë˜ ë¦¬ë·° ëª©ë¡ì˜ ê°ì •ì„ ë¶„ë¥˜í•©ë‹ˆë‹¤. ê°€ëŠ¥í•œ ê°’: 0(ë¶€ì •), 1(ì¤‘ë¦½), 2(ê¸ì •)\n"
        "í˜•ì‹: ìˆ«ìë§Œ, ê° ë¦¬ë·° ì•ì— ë²ˆí˜¸ì™€ í•¨ê»˜ ë‚˜ì—´í•˜ì„¸ìš”.\n"
    )
    for i, r in enumerate(reviews, start=1):
        prompt += f"{i}. {r}\n"
    prompt += "ë‹µ:"
    return prompt

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 3) ì‘ë‹µ íŒŒì‹±
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def parse_response(text, expected):
    tokens = [t.strip() for t in text.replace(',', ' ').split()]
    vals = [int(t) for t in tokens if t.isdigit()]
    if len(vals) < expected:
        vals += [None] * (expected - len(vals))
    return vals[:expected]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 4) LM Studioë¡œ ê°ì„± ë¶„ë¥˜ ìš”ì²­
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def classify_batch(reviews):
    payload = {
        "model":       MODEL_NAME,
        "prompt":      make_batch_prompt(reviews),
        "max_tokens":  5,
        "temperature": 0.0
    }
    r = requests.post(API_URL, json=payload)
    r.raise_for_status()  # HTTP ì˜¤ë¥˜ ë°œìƒ ì‹œ ì˜ˆì™¸
    resp = r.json()
    return parse_response(resp["choices"][0]["text"], len(reviews))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 5) CSV íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CSV_INPUT  = r"D:\_DeepNLP25\site\cache\merged_reviews.csv"
CSV_OUTPUT = r"D:\_DeepNLP25\site\cache\reviews_labeled.csv"

df = pd.read_csv(CSV_INPUT, encoding="utf-8-sig", low_memory=False)
if "label" not in df.columns:
    df["label"] = None
df["model_used"] = None

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 6) ë°°ì¹˜ ì²˜ë¦¬ (ì²´í¬í¬ì¸íŠ¸ ë¡œì§ ì œê±°ë¨)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BATCH_SIZE = 10
for start in tqdm(range(0, len(df), BATCH_SIZE), desc="LLM ë¶„ë¥˜ ì¤‘"):
    end   = min(start + BATCH_SIZE, len(df))
    batch = df.iloc[start:end]

    # ì´ë¯¸ ë¼ë²¨ë§ëœ ê²½ìš° ê±´ë„ˆëœ€
    if batch["label"].notna().all():
        continue

    reviews = batch["review"].tolist()
    labels  = classify_batch(reviews)

    # ìƒìœ„ ëª‡ ê°œ ê²°ê³¼ í™•ì¸ (ë””ë²„ê·¸ìš©)
    print(df.iloc[start : start + 3][["review", "label"]])
    
    # ì´ë²ˆ ë°°ì¹˜ ì¤‘ ë¶€ì •(0), ì¤‘ë¦½(1)ì¸ ë¦¬ë·°ë§Œ ì¶”ë ¤ ë³´ê¸° (ì˜µì…˜)
    filtered = df.iloc[start:end]
    subset  = filtered[filtered["label"].isin([0,1])]
    if not subset.empty:
        print("\nğŸ” ì´ë²ˆ ë°°ì¹˜ ì¤‘ 0/1 ê°ì • ë¦¬ë·°:")
        print(subset[["review","label"]].head(5))

    # ë¼ë²¨ ë° ëª¨ë¸ëª… ì—…ë°ì´íŠ¸
    for idx, lab in zip(batch.index, labels):
        df.at[idx, "label"]       = lab
        df.at[idx, "model_used"]  = "gemma-lmstudio"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 7) ê²°ê³¼ ì €ì¥
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
df.to_csv(CSV_OUTPUT, index=False, encoding="utf-8-sig")
print("âœ… ê°ì • ë¶„ë¥˜ ë° ì €ì¥ ì™„ë£Œ.")
